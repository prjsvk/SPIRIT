<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spirit - Time Companion</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Montserrat:wght@300;400;500;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="navbar.css" />
  <style>
    :root {
      --primary: #083464;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --accent: #f72585;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --gray: #6c757d;
      --success: #4cc9f0;
      --ai-bubble: #3f37c9;
      --user-bubble: #f72585;
      --chat-bg: #0f172a;
    }

    body {
      background: var(--chat-bg);
      color: white;
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
      color: white;
    }

    .logo i {
      color: var(--accent);
    }

    /* Main Layout */
    .main-layout {
      display: flex;
      height: calc(100vh - 100px);
      margin-top: 100px;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 280px;
      background: rgba(15, 23, 42, 0.95);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      padding: 1rem;
      overflow-y: auto;
    }

    .new-chat-btn {
      background: linear-gradient(135deg, var(--accent), var(--primary-light));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 0.8rem 1rem;
      cursor: pointer;
      font-weight: bold;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .new-chat-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(247, 37, 133, 0.4);
    }

    .chat-history-title {
      font-size: 0.9rem;
      color: var(--gray);
      margin-bottom: 1rem;
      text-transform: uppercase;
      font-weight: 600;
    }

    .chat-history-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chat-history-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .chat-history-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    .chat-history-item.active {
      background: rgba(247, 37, 133, 0.2);
      border-color: var(--accent);
    }

    .chat-history-item-title {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-history-item-date {
      font-size: 0.75rem;
      color: var(--gray);
    }

    .chat-history-item-delete {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 0, 0, 0.3);
      border: none;
      color: white;
      padding: 0.3rem 0.5rem;
      border-radius: 5px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .chat-history-item:hover .chat-history-item-delete {
      opacity: 1;
    }

    .chat-container {
      flex: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .chat-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(63, 55, 201, 0.1) 0%, rgba(15, 23, 42, 1) 70%);
      z-index: -1;
      animation: pulse 15s infinite alternate;
    }

    .chat-container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(63, 55, 201, 0.1) 0%, rgba(15, 23, 42, 1) 70%);
      z-index: -1;
      animation: pulse 15s infinite alternate;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 0.3;
      }
      100% {
        transform: scale(1.1);
        opacity: 0.5;
      }
    }

    .chat-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .chat-header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      background: linear-gradient(90deg, var(--accent), var(--primary-light));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 0 10px rgba(247, 37, 133, 0.3);
    }

    .chat-header p {
      color: var(--gray);
      font-size: 1rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      margin-bottom: 1rem;
      scroll-behavior: smooth;
      min-height: 0;
    }

    .message {
      display: flex;
      margin-bottom: 1.5rem;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.3s ease;
    }

    .message:hover {
      transform: translateY(-3px);
    }

    .message-ai {
      justify-content: flex-start;
    }

    .message-user {
      justify-content: flex-end;
    }

    .message-bubble {
      max-width: 70%;
      padding: 1rem 1.5rem;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transform: translateZ(10px);
    }

    .message-ai .message-bubble {
      background: var(--ai-bubble);
      border-bottom-left-radius: 5px;
      color: white;
      animation: floatIn 0.5s ease-out;
    }

    .message-user .message-bubble {
      background: var(--user-bubble);
      border-bottom-right-radius: 5px;
      color: white;
      animation: floatIn 0.5s ease-out;
    }

    .chat-input-container {
      display: flex;
      padding: 1rem;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
      margin-top: auto;
    }

    .chat-input {
      flex: 1;
      padding: 1rem;
      border: none;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      outline: none;
      transition: all 0.3s ease;
    }

    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .chat-input:focus {
      background: rgba(255, 255, 255, 0.15);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .send-button {
      background: linear-gradient(135deg, var(--accent), var(--primary-light));
      color: white;
      border: none;
      border-radius: 15px;
      padding: 0 1.5rem;
      margin-left: 1rem;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floating-bubble {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes floatIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Loading Indicator */
    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      background: var(--ai-bubble);
      border-radius: 20px;
      border-bottom-left-radius: 5px;
      max-width: fit-content;
      animation: floatIn 0.5s ease-out;
    }

    .loading-dots {
      display: flex;
      gap: 0.3rem;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      animation: loadingBounce 1.4s infinite ease-in-out;
    }

    .loading-dot:nth-child(1) {
      animation-delay: 0s;
    }

    .loading-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .loading-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes loadingBounce {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    #voiceButton {
      background: linear-gradient(135deg, var(--primary-light), var(--accent));
      margin-left: 0.5rem;
      padding: 0 1rem;
      border: none;
      border-radius: 15px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    #voiceButton.glowing {
      animation: glowPulse 1s infinite;
    }

    @keyframes glowPulse {
      0% { box-shadow: 0 0 10px var(--accent); }
      50% { box-shadow: 0 0 20px var(--primary-light); }
      100% { box-shadow: 0 0 10px var(--accent); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -280px;
        top: 80px;
        height: calc(100vh - 80px);
        z-index: 100;
        transition: left 0.3s ease;
      }

      .sidebar.open {
        left: 0;
      }

      .main-layout {
        flex-direction: column;
      }

      .chat-container {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <nav class="navbar">
      <div class="logo">
        <i class="ri-leaf-fill"></i>
        <span>Spirit</span>
      </div>
      <ul class="nav-links">
        <li><a href="home.html">Dashboard</a></li>
        <li><a href="FocusArena.html">Focus</a></li>
        <li><a href="spiritradio.html">Radio</a></li>
        <li><a href="mindmap.html">Mind Map</a></li>
        <li><a href="chat.html" class="active">Chat</a></li>
        <li><a href="quiz.html">Quiz</a></li>
        <li>
          <button onclick="location.href='index.html'" class="signout-button">Sign Out</button>
        </li>
      </ul>
    </nav>
  </header>

  <div class="main-layout">
    <!-- Sidebar -->
    <div class="sidebar">
      <button class="new-chat-btn" id="newChatBtn">
        <i class="ri-add-line"></i>
        New Chat
      </button>
      <div class="chat-history-title">Chat History</div>
      <div class="chat-history-list" id="chatHistoryList">
        <!-- Chat history items will be inserted here -->
      </div>
    </div>

    <!-- Main Chat Area -->
    <div class="chat-container" id="chatContainer">
      <div class="floating-bubble">Spirit AI v3.0</div>
      <div class="chat-header">
        <h1>Spirit AI</h1>
        <p>Your Time-Traveling Productivity Assistant</p>
      </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message message-ai">
        <div class="ai-avatar"><i class="ri-robot-2-line"></i></div>
        <div class="message-bubble">Hey ðŸ‘‹ I'm Spirit. Ready to optimize your timeline? Drop your thoughts below, and let's shape the future.</div>
      </div>
        <div class="typing-indicator" id="typingIndicator" style="display:none;">
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
          <span class="typing-dot"></span>
        </div>
    </div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="userInput" placeholder="Type your command or journal entry..." autocomplete="off">
      <button class="send-button" id="sendButton"><i class="ri-send-plane-fill"></i></button>
      <button class="send-button" id="voiceButton" title="Speak"><i class="ri-mic-fill" id="micIcon"></i></button>
    </div>
    </div>
  </div>

  <script>
      document.addEventListener('DOMContentLoaded', () => {
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const voiceButton = document.getElementById('voiceButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const newChatBtn = document.getElementById('newChatBtn');
        const chatHistoryList = document.getElementById('chatHistoryList');

        // Chat management
        let allChats = JSON.parse(localStorage.getItem('spiritAllChats')) || [];
        let currentChatId = localStorage.getItem('spiritCurrentChatId') || null;
        let conversationHistory = [];
        let moodState = "neutral";

        // Initialize
        if (allChats.length === 0) {
          createNewChat();
        } else {
          if (currentChatId && allChats.find(c => c.id === currentChatId)) {
            loadChat(currentChatId);
          } else {
            loadChat(allChats[0].id);
          }
        }
        renderChatHistory();

        function generateChatId() {
          return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function createNewChat() {
          const newChat = {
            id: generateChatId(),
            title: 'New Chat',
            messages: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          allChats.unshift(newChat);
          localStorage.setItem('spiritAllChats', JSON.stringify(allChats));
          currentChatId = newChat.id;
          localStorage.setItem('spiritCurrentChatId', currentChatId);
          conversationHistory = [];
          chatMessages.innerHTML = '';
          addMessage('ai', "ðŸ‘‹ Hey there! I'm Spirit AI â€” your personal productivity time traveler. What are we focusing on today?", false);
          renderChatHistory();
        }

        function loadChat(chatId) {
          const chat = allChats.find(c => c.id === chatId);
          if (!chat) return;
          
          currentChatId = chatId;
          localStorage.setItem('spiritCurrentChatId', currentChatId);
          conversationHistory = chat.messages || [];
          
          chatMessages.innerHTML = '';
          if (conversationHistory.length === 0) {
            addMessage('ai', "ðŸ‘‹ Hey there! I'm Spirit AI â€” your personal productivity time traveler. What are we focusing on today?", false);
          } else {
            conversationHistory.forEach(msg => addMessage(msg.role, msg.content, false));
          }
          renderChatHistory();
        }

        function saveCurrentChat() {
          const chat = allChats.find(c => c.id === currentChatId);
          if (chat) {
            chat.messages = conversationHistory;
            chat.updatedAt = new Date().toISOString();
            
            // Update title based on first user message
            if (conversationHistory.length > 0 && chat.title === 'New Chat') {
              const firstUserMsg = conversationHistory.find(m => m.role === 'user');
              if (firstUserMsg) {
                chat.title = firstUserMsg.content.substring(0, 30) + (firstUserMsg.content.length > 30 ? '...' : '');
              }
            }
            
            localStorage.setItem('spiritAllChats', JSON.stringify(allChats));
          }
        }

        function deleteChat(chatId) {
          allChats = allChats.filter(c => c.id !== chatId);
          localStorage.setItem('spiritAllChats', JSON.stringify(allChats));
          
          if (currentChatId === chatId) {
            if (allChats.length > 0) {
              loadChat(allChats[0].id);
            } else {
              createNewChat();
            }
          }
          renderChatHistory();
        }

        function renderChatHistory() {
          chatHistoryList.innerHTML = '';
          allChats.forEach(chat => {
            const item = document.createElement('div');
            item.className = 'chat-history-item' + (chat.id === currentChatId ? ' active' : '');
            item.innerHTML = `
              <div class="chat-history-item-title">${chat.title}</div>
              <div class="chat-history-item-date">${new Date(chat.updatedAt).toLocaleDateString()}</div>
              <button class="chat-history-item-delete" onclick="event.stopPropagation();">
                <i class="ri-delete-bin-line"></i>
              </button>
            `;
            item.addEventListener('click', () => loadChat(chat.id));
            item.querySelector('.chat-history-item-delete').addEventListener('click', () => {
              if (confirm('Delete this chat?')) {
                deleteChat(chat.id);
              }
            });
            chatHistoryList.appendChild(item);
          });
        }

        newChatBtn.addEventListener('click', createNewChat);

        function formatMessage(text) {
          let formatted = text
            .replace(/[*_~`#>]+/g, '')
            .replace(/\n{2,}/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/```(\w*)\n?([\s\S]+?)```/g, '<pre><code>$2</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>');
          return `<p>${formatted}</p>`;
        }

        function addMessage(role, content, saveToHistory = true) {
          const msg = document.createElement('div');
          msg.className = `message message-${role}`;
          msg.innerHTML = role === 'ai'
            ? `<div class="ai-avatar"><i class="ri-robot-2-line"></i></div><div class="message-bubble">${formatMessage(content)}</div>`
            : `<div class="message-bubble">${formatMessage(content)}</div>`;
          chatMessages.appendChild(msg);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          if (saveToHistory) {
            conversationHistory.push({ role, content });
            saveCurrentChat();
          }
        }

        function showLoadingIndicator() {
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'message message-ai';
          loadingDiv.id = 'loadingIndicator';
          loadingDiv.innerHTML = `
            <div class="ai-avatar"><i class="ri-robot-2-line"></i></div>
            <div class="loading-indicator">
              <div class="loading-dots">
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
              </div>
            </div>
          `;
          chatMessages.appendChild(loadingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideLoadingIndicator() {
          const loadingDiv = document.getElementById('loadingIndicator');
          if (loadingDiv) {
            loadingDiv.remove();
          }
        }

        function detectSimulationPrompt(input) {
          const triggers = ["what if i", "skip", "miss", "delay", "postpone"];
          return triggers.some(trigger => input.toLowerCase().includes(trigger));
        }

        function detectMood(input) {
          const text = input.toLowerCase();
          if (text.includes("burned out") || text.includes("exhausted") || text.includes("tired")) return "tired";
          if (text.includes("stressed") || text.includes("pressure")) return "stressed";
          if (text.includes("great") || text.includes("excited")) return "motivated";
          if (text.includes("sad") || text.includes("lazy")) return "low";
          return "neutral";
        }

        async function getAIResponse(userMessage) {
          // Check for default questions first
          const lowerMessage = userMessage.toLowerCase();
          
          if (lowerMessage.includes("what is a hackathon") || lowerMessage.includes("what's a hackathon")) {
            return "ðŸš€ A hackathon is an exciting collaborative event where developers, designers, and innovators come together to build creative projects within a limited timeframe (usually 24-48 hours). It's like a sprint for innovation! Participants form teams, brainstorm ideas, code intensively, and present their prototypes. Hackathons are great for learning new skills, networking, and turning ideas into reality. Many successful startups and products have been born at hackathons!";
          }
          
          if (lowerMessage.includes("what is an llm") || lowerMessage.includes("what's an llm") || lowerMessage.includes("what is a llm")) {
            return "ðŸ¤– An LLM (Large Language Model) is an AI system trained on vast amounts of text data to understand and generate human-like language. Think of it as a highly sophisticated pattern recognizer that learned from billions of words across books, websites, and documents. LLMs like GPT, Claude, and Gemini can write, answer questions, code, translate, and more. They work by predicting the most likely next word based on context, using neural networks with billions of parameters. I'm powered by similar technology to help you be more productive!";
          }
          
          if (lowerMessage.includes("how many bones") && (lowerMessage.includes("adult human") || lowerMessage.includes("human body"))) {
            return "ðŸ¦´ An adult human body has 206 bones! Interestingly, babies are born with around 270 bones, but as they grow, some of these bones fuse together. The skeleton provides structure, protects vital organs, stores minerals, produces blood cells, and enables movement. The smallest bone is the stapes in the ear (about 3mm), while the largest is the femur (thigh bone). Fun fact: More than half of your bones are in your hands and feet!";
          }

          const isSimulated = detectSimulationPrompt(userMessage);
          moodState = detectMood(userMessage);

          let systemPrompt = "";
          if (isSimulated) {
            systemPrompt = `You are Spirit AI, a futuristic assistant. Simulate the outcome of missed or skipped tasks using a cascading chain of consequences (ChronoLoop Simulation). Be realistic, engaging, and use emoji sparingly for emotional impact.`;
          } else {
            systemPrompt = `You are Spirit AI â€” a smart, emotionally aware productivity assistant. The user's current mood is "${moodState}". Based on that, respond with empathy and either encouragement or relief. If they seem demotivated, suggest a lighter alternative. If theyâ€™re overconfident, balance with realism.`;
          }

          try {
            // GET /generate?prompt=...
            const url = `http://127.0.0.1:5000/generate?prompt=${encodeURIComponent(userMessage)}`;
            typingIndicator.style.display = 'flex';
            const res = await fetch(url, {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' },
            });
            const json = await res.json();
            typingIndicator.style.display = 'none';
            return json.response || json.reply || json?.choices?.[0]?.message?.content || '';
          } catch (err) {
            typingIndicator.style.display = 'none';
            console.error(err);
            return "âš ï¸ I couldnâ€™t connect to my futuristic servers. Try again soon!";
          }
        }

        async function sendMessage() {
          const message = userInput.value.trim();
          if (!message) return;
          addMessage('user', message);
          userInput.value = '';
          showLoadingIndicator();
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // Start fetching the AI response
          const aiReplyPromise = getAIResponse(message);
          
          // Wait for at least 8 seconds
          const minLoadingTime = new Promise(resolve => setTimeout(resolve, 8000));
          
          // Wait for both the response and the minimum loading time
          const [aiReply] = await Promise.all([aiReplyPromise, minLoadingTime]);
          
          hideLoadingIndicator();
          addMessage('ai', aiReply);
        }

        sendButton.onclick = sendMessage;
        userInput.addEventListener("keypress", e => {
          if (e.key === "Enter") sendMessage();
        });

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
          const recognition = new SpeechRecognition();
          recognition.lang = 'en-US';
          recognition.continuous = false;
          recognition.onstart = () => voiceButton.classList.add("glowing");
          recognition.onend = () => voiceButton.classList.remove("glowing");
          recognition.onresult = e => {
            const transcript = e.results[0][0].transcript;
            userInput.value = transcript;
          };
          voiceButton.onclick = () => recognition.start();
        } else {
          voiceButton.disabled = true;
          voiceButton.title = "Voice input not supported.";
        }
      });
  </script>
  <!--Accesibility widget-->
  <script src="https://cdn.userway.org/widget.js" data-account="ertbJPpxpJ"></script>
</body>
</html>